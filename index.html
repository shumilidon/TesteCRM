<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Jurídico - Advocacia (com Login)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Estilos da tela de login */
        #loginScreen {
            display: flex; /* Alterado para flex no JS */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
        }
        #loginScreen > div {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            max-width: 400px;
            width: 90%;
        }
        #loginScreen h2 {
            color: #ecf0f1;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        #loginScreen p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            line-height: 1.5;
        }
        #loginScreen .token-example {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #ecf0f1;
            text-align: center;
        }
        #loginScreen .token-example strong {
            color: #3498db;
        }
        #baserowTokenInput {
            width: 100%;
            padding: 15px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            text-align: center;
        }
        #loginError {
            color: #e74c3c;
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        /* Estilos gerais do CRM */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-container {
            display: flex;
            justify-content: space-between; /* Alinha stats à esquerda e actions à direita */
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08); /* Fundo sutil para o header */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .stats-compact {
            display: flex;
            gap: 15px; /* Espaço entre os pills de estatísticas */
        }

        .stat-pill {
            background: rgba(255, 255, 255, 0.15); /* Fundo mais claro para os pills */
            padding: 10px 15px;
            border-radius: 20px; /* Bordas mais arredondadas */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 80px; /* Largura mínima para cada pill */
        }

        .stat-number-compact {
            font-size: 1.5rem; /* Tamanho maior para o número */
            font-weight: 700;
            color: #ecf0f1;
            display: block;
        }

        .stat-label-compact {
            font-size: 0.8rem;
            color: rgba(236, 240, 241, 0.8);
            text-transform: uppercase;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px; /* Espaço entre os botões de ação */
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.2);
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; /* Botões redondos */
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .btn-icon-primary {
            background: #3498db;
            border-color: #2980b9;
            color: white;
        }
        .btn-icon-primary:hover {
            background: #2980b9;
        }
        .btn-icon-secondary {
            background: #95a5a6;
            border-color: #7f8c8d;
            color: white;
        }
        .btn-icon-secondary:hover {
            background: #7f8c8d;
        }
        .btn-icon.btn-danger {
            background: #e74c3c;
            border-color: #c0392b;
            color: white;
        }
        .btn-icon.btn-danger:hover {
            background: #c0392b;
        }

        .controls {
            display: flex;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            justify-content: space-between; /* Para separar search-container e botão do calendário */
            align-items: center;
        }
        .search-container {
            display: flex;
            gap: 10px; /* Espaço entre os filtros e a busca */
            flex-wrap: wrap; /* Permite que os itens quebrem linha se necessário */
            flex-grow: 1; /* Permite que o container de busca cresça */
        }
        .btn {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            box-shadow: 0 4px 15px rgba(127, 140, 141, 0.3);
        }
        .search-box {
            flex: 1; /* Ocupa espaço disponível */
            min-width: 200px; /* Largura mínima para a caixa de busca */
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        .search-box:focus {
            border-color: #2c3e50;
            transform: scale(1.02);
        }
        .filter-select {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 180px;
        }
        .filter-select:focus,
        .filter-select:hover {
            border-color: #2c3e50;
            transform: scale(1.02);
        }
        .clientes-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .status-groups-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .status-group {
            flex: 1;
            min-width: 300px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-group-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #ecf0f1;
            margin-bottom: 20px;
            padding-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .cliente-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .cliente-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }
        .cliente-header {
            display: flex;
            flex-direction: column; 
            align-items: flex-start; 
            margin-bottom: 10px; 
        }
        .cliente-info-principal {
            display: flex;
            align-items: center; 
            gap: 10px; 
            margin-bottom: 5px; 
            width: 100%; 
            justify-content: space-between; /* Empurra o status da tarefa para a direita */
        }
        .cliente-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            flex-grow: 1; /* Permite que o nome ocupe o espaço */
        }
        .cliente-email-tel-container {
            display: flex; /* Novo container para email/tel e status da tarefa */
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 5px;
        }
        .cliente-email-tel {
            color: #6b7280;
            font-size: 0.85rem;
        }
        .tarefa-status {
            /* margin-left: auto;  Removido, pois o space-between no container pai cuidará disso */
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .etapa-badge-container {
             display: inline-block; 
             margin-left: 10px; /* Adiciona um pequeno espaço se o nome for muito grande */
        }
        .etapa-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none; 
            cursor: pointer; 
            display: inline-block; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            min-width: 120px; 
            text-align: center; 
        }
        .etapa-badge:hover {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .etapa-badge-select {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none; 
            cursor: pointer;
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
            outline: none; 
            transition: all 0.2s ease; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            min-width: 120px; 
            text-align: center; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23ffffff%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            padding-right: 24px; 
        }
        .etapa-badge-select:focus {
             box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5), 0 4px 8px rgba(0, 0, 0, 0.2); 
             transform: translateY(-1px); 
             background: linear-gradient(135deg, #3498db, #2980b9); 
             color: white; 
        }
        .etapa-badge-select:hover {
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25); 
             transform: translateY(-1px); 
             background: linear-gradient(135deg, #3498db, #2980b9); 
        }
        .etapa-badge-select option {
             background-color: #3498db; 
             color: white; 
             font-weight: 500; 
        }
        .cliente-detalhes {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .cliente-card.expandido .cliente-detalhes {
            display: block;
        }
        .cliente-info {
            margin: 15px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .info-label {
            color: #6b7280;
            font-weight: 500;
        }
        .info-value {
            color: #1f2937;
            font-weight: 600;
        }
        .cliente-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .btn-edit {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .btn-edit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .form-row {
            display: flex;
            margin-bottom: 18px;
        }
        .form-row .form-group {
            margin-bottom: 0;
        }
        .modal-content {
            background: #ffffff; 
            border-radius: 12px; 
            padding: 30px; 
            max-width: 500px; 
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
            border: none; 
        }
        .modal h2 {
            margin-bottom: 25px; 
            color: #333; 
            font-size: 1.8rem; 
            text-align: center; 
        }
        .form-group {
            margin-bottom: 18px; 
        }
        .form-group label {
            display: block;
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 500; 
            font-size: 1rem; 
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            outline: none;
            transition: all 0.2s ease;
            background: #f9f9f9; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); 
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); 
            transform: none; 
        }
        .form-group textarea {
            height: 100px; 
            resize: vertical; 
        }
        .modal-actions {
            display: flex;
            gap: 15px; 
            justify-content: flex-end;
            margin-top: 30px; 
        }
       
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="loginScreen">
        <div>
            <h2>CRM Jurídico - Login</h2>
            <p>Insira seu token do Baserow no formato <strong>TABLE_ID-TOKEN</strong> para acessar o sistema.</p>
            <div class="token-example">
                Exemplo: <strong>12345</strong>-AbCdEfGhIjKlMnOpQrStUvWxYz
            </div>
            <input type="text" id="baserowTokenInput" placeholder="Insira seu token no formato TABLE_ID-TOKEN">
            <button onclick="handleLogin()" class="btn" style="width: 100%;">Entrar</button>
            <p id="loginError" style="display: none;">Token inválido. Tente novamente.</p>
        </div>
    </div>

    <!-- Conteúdo Principal do CRM (inicialmente oculto) -->
    <div id="crmContent" style="display: none;">
        <div class="container">
            <div class="header-container">
                <div class="stats-compact">
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="totalClientes">0</div>
                        <div class="stat-label-compact">Total</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesAtivos">0</div>
                        <div class="stat-label-compact">Ativos</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesPendentes">0</div>
                        <div class="stat-label-compact">Pendentes</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesArquivados">0</div>
                        <div class="stat-label-compact">Arquivados</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-primary" title="Novo Cliente" onclick="adicionarCliente()">+</button>
                    <button class="btn-icon btn-icon-secondary" title="Sincronizar Baserow" onclick="sincronizarBaserow()">🔄</button>
                    <button class="btn-icon" title="Limpar Filtros" onclick="limparFiltros()">🗑️</button>
                    <button class="btn-icon btn-danger" title="Logout" onclick="handleLogout()">🚪</button>
                </div>
            </div>

            <div class="controls">
                <div class="search-container">
                    <select class="filter-select" id="filtroTipo" onchange="filtrarPorTipo(this.value)">
                        <option value="">Todos os Tipos</option>
                        <option value="Civil">Direito Civil</option>
                        <option value="Criminal">Direito Criminal</option>
                        <option value="Trabalhista">Direito Trabalhista</option>
                        <option value="Empresarial">Direito Empresarial</option>
                        <option value="Família">Direito de Família</option>
                        <option value="Tributário">Direito Tributário</option>
                    </select>
                    <select class="filter-select" id="filtroStatus" onchange="filtrarPorStatus(this.value)">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Arquivado">Arquivado</option>
                    </select>
                    <input type="text" class="search-box" placeholder="Buscar clientes..." onkeyup="filtrarClientes(this.value)">
                </div>
                <div class="calendar-button-container"> <!-- Novo container para o botão do calendário -->
                    <button class="btn" id="btnToggleCalendario" onclick="toggleCalendario()">Ver Calendário de Tarefas</button>
                </div>
            </div>

            <!-- Calendário de Tarefas (inicialmente oculto) -->
            <div id="calendarioContainer" style="display: none; margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 style="color: #ecf0f1; margin-bottom: 15px; text-align: center;">Calendário de Tarefas</h2>
                    <div id="calendarioControles" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <button class="btn-small" onclick="mudarMes(-1)">◀ Mês Anterior</button>
                        <h3 id="mesAnoAtual" style="color: #ecf0f1; margin: 0; align-self: center;">Junho 2025</h3>
                        <button class="btn-small" onclick="mudarMes(1)">Próximo Mês ▶</button>
                    </div>
                    <div id="calendario" style="background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 15px; color: #333;"></div>
                </div>
            </div>

            <div class="status-groups-container">
                <!-- Seção de Clientes Ativos -->
                <div class="status-group">
                    <h2 class="status-group-title">Ativos</h2>
                    <div class="clientes-grid" id="gridAtivos">
                        <!-- Clientes ativos serão carregados aqui -->
                    </div>
                </div>

                <!-- Seção de Clientes Pendentes -->
                <div class="status-group">
                    <h2 class="status-group-title">Pendentes</h2>
                    <div class="clientes-grid" id="gridPendentes">
                        <!-- Clientes pendentes serão carregados aqui -->
                    </div>
                </div>

                <!-- Seção de Clientes Arquivados -->
                <div class="status-group">
                    <h2 class="status-group-title">Arquivados</h2>
                    <div class="clientes-grid" id="gridArquivados">
                        <!-- Clientes arquivados serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar/editar cliente -->
        <div class="modal" id="clienteModal">
            <div class="modal-content">
                <h2 id="modalTitle">Novo Cliente</h2>
                <form id="clienteForm">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="nome" required placeholder="Nome do cliente">
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1; margin-right: 10px;">
                            <label>Email</label>
                            <input type="email" id="email" required placeholder="email@exemplo.com">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Telefone</label>
                            <input type="tel" id="telefone" required placeholder="(00) 00000-0000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1; margin-right: 10px;">
                            <label>Tipo de Caso</label>
                            <select id="tipoCaso" required>
                                <option value="">Selecione...</option>
                                <option value="Civil">Direito Civil</option>
                                <option value="Criminal">Direito Criminal</option>
                                <option value="Trabalhista">Direito Trabalhista</option>
                                <option value="Empresarial">Direito Empresarial</option>
                                <option value="Família">Direito de Família</option>
                                <option value="Tributário">Direito Tributário</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Status</label>
                            <select id="status" required>
                                <option value="Ativo">Ativo</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Arquivado">Arquivado</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Advogado Responsável</label>
                        <input type="text" id="advogadoResponsavel" placeholder="Nome do advogado responsável">
                    </div>
                    <div class="form-group">
                        <label>Observações</label>
                        <textarea id="observacoes" rows="3" placeholder="Detalhes do caso, documentos necessários, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Próxima Etapa (Acompanhamento)</label>
                        <textarea id="acompanhamento" rows="2" placeholder="Descreva a próxima etapa ou tarefa a ser realizada"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Data de Expiração</label>
                        <input type="datetime-local" id="expira" placeholder="Data e hora limite">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-small btn-danger" onclick="fecharModal()">Cancelar</button>
                        <button type="button" id="saveClientButton" class="btn-small btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Confirmação de Exclusão -->
        <div class="modal" id="confirmDeleteModal">
            <div class="modal-content">
                <h2>Confirmar Exclusão</h2>
                <p id="confirmDeleteMessage" style="margin-bottom: 30px; color: #555; line-height: 1.6; text-align: center;">Tem certeza que deseja excluir este cliente?</p>
                <div class="modal-actions">
                    <button type="button" class="btn-small" style="background-color: #f5f5f5; color: #333;" onclick="fecharConfirmDeleteModal()">Cancelar</button>
                    <button type="button" id="confirmDeleteButton" class="btn-small btn-danger">Confirmar Exclusão</button>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"></div>
    </div> <!-- Fim do crmContent -->

    <script>
        // Variáveis e funções para o calendário
        let dataCalendarioAtual = new Date();
        let clientesComTarefas = [];
        let calendarioVisivel = false;
        
        function toggleCalendario() {
            if (calendarioVisivel) {
                fecharCalendario();
            } else {
                mostrarCalendario();
            }
        }
        
        function mostrarCalendario() {
            atualizarClientesComTarefas();
            atualizarTituloCalendario();
            renderizarCalendario();
            document.getElementById('calendarioContainer').style.display = 'block';
            document.getElementById('btnToggleCalendario').textContent = 'Fechar Calendário de Tarefas';
            calendarioVisivel = true;
        }
        
        function fecharCalendario() {
            document.getElementById('calendarioContainer').style.display = 'none';
            document.getElementById('btnToggleCalendario').textContent = 'Ver Calendário de Tarefas';
            calendarioVisivel = false;
        }
        
        function atualizarClientesComTarefas() {
            clientesComTarefas = clientes.filter(cliente => cliente.expira && cliente.expira.trim() !== '');
        }
        
        function atualizarTituloCalendario() {
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const mes = meses[dataCalendarioAtual.getMonth()];
            const ano = dataCalendarioAtual.getFullYear();
            document.getElementById('mesAnoAtual').textContent = `${mes} ${ano}`;
        }
        
        function mudarMes(delta) {
            dataCalendarioAtual.setMonth(dataCalendarioAtual.getMonth() + delta);
            atualizarTituloCalendario();
            renderizarCalendario();
        }
        
        function renderizarCalendario() {
            const calendario = document.getElementById('calendario');
            const ano = dataCalendarioAtual.getFullYear();
            const mes = dataCalendarioAtual.getMonth();
            const primeiroDia = new Date(ano, mes, 1);
            const ultimoDia = new Date(ano, mes + 1, 0);
            const primeiroDiaSemana = primeiroDia.getDay();
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(dia => `<th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${dia}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let dia = 1;
            let htmlSemana = '<tr>';
            for (let i = 0; i < primeiroDiaSemana; i++) {
                htmlSemana += '<td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top;"></td>';
            }
            
            while (dia <= ultimoDia.getDate()) {
                if ((dia + primeiroDiaSemana - 1) % 7 === 0 && dia !== 1) {
                    htmlSemana += '</tr><tr>';
                }
                
                const tarefasDoDia = obterTarefasDoDia(ano, mes, dia);
                const hoje = new Date();
                const ehHoje = hoje.getDate() === dia && hoje.getMonth() === mes && hoje.getFullYear() === ano;
                const estiloDia = ehHoje ? 'background-color: rgba(52, 152, 219, 0.2);' : '';
                
                htmlSemana += `
                    <td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top; ${estiloDia}">
                        <div style="font-weight: bold; margin-bottom: 5px;">${dia}</div>
                        ${tarefasDoDia}
                    </td>
                `;
                dia++;
            }
            
            const ultimoDiaSemana = new Date(ano, mes, ultimoDia.getDate()).getDay();
            for (let i = ultimoDiaSemana + 1; i < 7; i++) {
                htmlSemana += '<td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top;"></td>';
            }
            
            htmlSemana += '</tr>';
            html += htmlSemana + '</tbody></table>';
            calendario.innerHTML = html;
        }
        
        function obterTarefasDoDia(ano, mes, dia) {
            let html = '';
            const dataAtual = new Date(ano, mes, dia);
            
            const tarefasDoDia = clientesComTarefas.filter(cliente => {
                if (!cliente.expira) return false;
                const dataExpira = new Date(cliente.expira);
                return dataExpira.getDate() === dia && 
                       dataExpira.getMonth() === mes && 
                       dataExpira.getFullYear() === ano;
            });

            tarefasDoDia.forEach(tarefa => {
                const hora = new Date(tarefa.expira).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                html += `<div style="font-size: 0.8em; padding: 2px 4px; margin-bottom: 3px; background-color: ${tarefa.tarefaConcluida ? '#d4edda' : '#f8d7da'}; border-radius: 3px; color: ${tarefa.tarefaConcluida ? '#155724' : '#721c24'};"><strong>${hora}</strong> - ${tarefa.nome.substring(0,15)}${tarefa.nome.length > 15 ? '...' : ''} (${tarefa.acompanhamento ? tarefa.acompanhamento.substring(0,20) : 'Tarefa'})</div>`;
            });
            return html;
        }

        // --- Configurações e Variáveis Globais --- 
        let BASEROW_CONFIG = {
            baseUrl: 'https://api.baserow.io/api/database/rows/table/',
            tableId: '', // Será preenchido pelo usuário
            token: '',   // Será preenchido pelo usuário
            headers: {
                'Authorization': '',
                'Content-Type': 'application/json'
            }
        };
        let clientes = [];
        let clienteEmEdicaoId = null;
        let clienteParaExcluirId = null;

        // --- Funções de Login e Sessão --- 
        async function testBaserowConnection(tableId, token) {
            try {
                const testHeaders = {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                };
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${tableId}/?size=1`, {
                    method: 'GET',
                    headers: testHeaders
                });
                return response.ok;
            } catch (error) {
                console.error('Erro no teste de conexão:', error);
                return false;
            }
        }

        function checkSession() {
            const storedToken = sessionStorage.getItem('baserowApiToken');
            const storedTableId = sessionStorage.getItem('baserowTableId');
            if (storedToken && storedTableId) {
                BASEROW_CONFIG.token = storedToken;
                BASEROW_CONFIG.tableId = storedTableId;
                BASEROW_CONFIG.headers.Authorization = `Token ${storedToken}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('crmContent').style.display = 'block';
                carregarClientes();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('crmContent').style.display = 'none';
            }
        }

        async function handleLogin() {
            const tokenInput = document.getElementById('baserowTokenInput').value.trim();
            const loginError = document.getElementById('loginError');
            
            loginError.style.display = 'none';
            
            if (!tokenInput) {
                loginError.textContent = 'Por favor, insira um token.';
                loginError.style.display = 'block';
                return;
            }

            // Extrai tableId e token
            // Formato esperado: tableId-TOKEN_REAL (ex: 12345-AbCdEfGhIjKlMnOpQrStUvWxYz0123456789)
            const parts = tokenInput.split('-');
            if (parts.length < 2) { // Verifica se há pelo menos um hífen
                loginError.textContent = 'Token inválido. O formato esperado é SEU_TABLE_ID-SEU_TOKEN. Certifique-se de incluir o hífen entre o ID da tabela e o token.';
                loginError.style.display = 'block';
                return;
            }
            
            const tableId = parts[0];
            const actualToken = parts.slice(1).join('-'); // Permite que o token em si contenha hífens

            if (!tableId || !actualToken) { // Verificação adicional
                loginError.textContent = 'Token inválido. ID da tabela ou token ausente. O formato esperado é SEU_TABLE_ID-SEU_TOKEN.';
                loginError.style.display = 'block';
                return;
            }

            // Testa a conexão com o Baserow usando o tableId e o token fornecidos
            mostrarNotificacao('🔑 Verificando token...', 'info', 2000);
            const isValidToken = await testBaserowConnection(tableId, actualToken);

            if (isValidToken) {
                sessionStorage.setItem('baserowApiToken', actualToken);
                sessionStorage.setItem('baserowTableId', tableId);
                BASEROW_CONFIG.token = actualToken;
                BASEROW_CONFIG.tableId = tableId;
                BASEROW_CONFIG.headers.Authorization = `Token ${actualToken}`;
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('crmContent').style.display = 'block';
                loginError.style.display = 'none';
                
                mostrarNotificacao('✅ Login bem-sucedido!', 'success');
                carregarClientes();
            } else {
                loginError.textContent = 'Token ou Table ID inválido. Verifique o formato TABLE_ID-TOKEN e tente novamente.';
                loginError.style.display = 'block';
                mostrarNotificacao('❌ Falha no login.', 'error');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('baserowApiToken');
            sessionStorage.removeItem('baserowTableId');
            BASEROW_CONFIG.token = '';
            BASEROW_CONFIG.tableId = '';
            BASEROW_CONFIG.headers.Authorization = '';
            clientes = [];
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('crmContent').style.display = 'none';
            // Limpa os grids para não mostrar dados antigos se outro usuário logar
            document.getElementById('gridAtivos').innerHTML = '';
            document.getElementById('gridPendentes').innerHTML = '';
            document.getElementById('gridArquivados').innerHTML = '';
            atualizarEstatisticas(); // Zera as estatísticas
            mostrarNotificacao('🔒 Logout realizado.', 'info');
        }

        // --- Funções CRUD com Baserow --- 
        async function carregarClientes() {
            if (!BASEROW_CONFIG.token) { handleLogout(); return; }
            mostrarNotificacao('Carregando clientes...', 'info', 5000);
            try {
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/?size=200`, { // Removido user_field_names=true
                    method: 'GET',
                    headers: BASEROW_CONFIG.headers
                });
                if (!response.ok) {
                    if (response.status === 401) { // Token inválido ou expirado
                        handleLogout();
                        mostrarNotificacao('Sessão expirada. Faça login novamente.', 'error');
                        return;
                    }
                    throw new Error(`Erro ao carregar clientes (${response.status})`);
                }
                const data = await response.json();
                clientes = data.results.map(item => ({
                    id: item.id,
                    nome: item.field_4457729 || "",
                    email: item.field_4457730 || "",
                    telefone: item.field_4457731 || "",
                    tipoCaso: item.field_4457749?.value || ", // Usar ?.value para campos de seleção única
                    advogadoResponsavel: item.field_4525191 || "",
                    status: item.field_4457750?.value || 'Pendente', // Default para Pendente se não definido
                    observacoes: item.field_4457752 || "",
                    etapa: item.field_4477668?.value || 'Análise Inicial', // Default para Etapa
                    acompanhamento: item.field_4524618 || "",
                    expira: item.field_4524619 || null, // Campo de data e hora
                    dataAtualizacao: item.field_4457753 || (item.updated_on ? item.updated_on.split('T')[0] : new Date().toISOString().split('T')[0]), // Campo de data
                    tarefaConcluida: item.field_4525198 || false // Campo booleanoo
                }));
                renderizarClientes();
                atualizarEstatisticas();
                mostrarNotificacao('Clientes carregados!', 'success');
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                mostrarNotificacao('Falha ao carregar clientes.', 'error');
                if (error.message.includes("401")) handleLogout(); // Se for erro de autenticação, desloga
            }
        }

        async function salvarClienteBaserow(dados) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return null; }
            try {
                const dadosBaserow = {
                    "field_4457729": dados.nome,
                    "field_4457730": dados.email,
                    "field_4457731": dados.telefone,
                    "field_4457749": dados.tipoCaso ? { value: dados.tipoCaso } : null,
                    "field_4525191": dados.advogadoResponsavel,
                    "field_4457750": dados.status ? { value: dados.status } : null,
                    "field_4457752": dados.observacoes,
                    "field_4524618": dados.acompanhamento,
                    "field_4524619": dados.expira || null, // Envia null se vazio
                    "field_4457753": dados.dataAtualizacao,
                    "field_4525198": dados.tarefaConcluida // Campo booleano
                };

                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/?user_field_names=true`, {
                    method: 'POST',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Salvar):", response.status, errorBody);
                    throw new Error(`Erro ao salvar (${response.status}): ${errorBody || response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Falha ao salvar cliente no Baserow:", error);
                return null;
            }
        }

        async function atualizarClienteBaserow(clienteId, dados) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return null; }
            try {
                const dadosBaserow = {
                    "field_4457729": dados.nome,
                    "field_4457730": dados.email,
                    "field_4457731": dados.telefone,
                    "field_4457749": dados.tipoCaso ? { value: dados.tipoCaso } : null,
                    "field_4525191": dados.advogadoResponsavel,
                    "field_4457750": dados.status ? { value: dados.status } : null,
                    "field_4457752": dados.observacoes,
                    "field_4524618": dados.acompanhamento,
                    "field_4524619": dados.expira || null,
                    "field_4457753": dados.dataAtualizacao,
                    "field_4525198": dados.tarefaConcluida
                };

                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/?user_field_names=true`, {
                    method: 'PATCH',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Atualizar):", response.status, errorBody);
                    throw new Error(`Erro ao atualizar (${response.status}): ${errorBody || response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Falha ao atualizar cliente no Baserow:", error);
                return null;
            }
        }

        async function excluirClienteBaserow(clienteId) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return false; }
            try {
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, {
                    method: 'DELETE',
                    headers: BASEROW_CONFIG.headers
                });
                if (!response.ok) {
                    // Se o status for 204 No Content, a exclusão foi bem-sucedida mesmo sem corpo de resposta
                    if (response.status === 204) return true;
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Excluir):", response.status, errorBody);
                    throw new Error(`Erro ao excluir (${response.status}): ${errorBody || response.statusText}`);
                }
                return true; // Sucesso (ou 204 No Content)
            } catch (error) {
                console.error("Falha ao excluir cliente no Baserow:", error);
                return false;
            }
        }

        // --- Funções de Renderização --- 
        function renderizarClientes() {
            const gridAtivos = document.getElementById('gridAtivos');
            const gridPendentes = document.getElementById('gridPendentes');
            const gridArquivados = document.getElementById('gridArquivados');
            
            gridAtivos.innerHTML = '';
            gridPendentes.innerHTML = '';
            gridArquivados.innerHTML = '';

            // Ordena os clientes pela data de atualização (mais recente primeiro)
            const clientesOrdenados = [...clientes].sort((a, b) => {
                const dataA = a.dataAtualizacao ? new Date(a.dataAtualizacao) : new Date(0); // Trata datas nulas
                const dataB = b.dataAtualizacao ? new Date(b.dataAtualizacao) : new Date(0);
                return dataB - dataA; // Decrescente
            });

            clientesOrdenados.forEach(cliente => {
                const card = criarCardCliente(cliente);
                if (cliente.status === 'Ativo') {
                    gridAtivos.appendChild(card);
                } else if (cliente.status === 'Pendente') {
                    gridPendentes.appendChild(card);
                } else if (cliente.status === 'Arquivado') {
                    gridArquivados.appendChild(card);
                }
            });
            aplicarFiltros(); // Aplica filtros após renderizar
        }

        // Função para mostrar o dropdown de etapas
        function mostrarDropdownEtapa(badgeElement, clienteId, etapaAtual) {
            const etapasDisponiveis = [
                'Análise Inicial', 'Coleta de Documentos', 'Elaboração da Peça', 
                'Protocolo', 'Aguardando Despacho', 'Recurso', 'Sustentação Oral',
                'Trânsito em Julgado', 'Execução', 'Finalizado'
            ];

            const select = document.createElement('select');
            select.className = 'etapa-badge-select'; // Usa a classe para estilizar como badge
            
            etapasDisponiveis.forEach(etapa => {
                const option = document.createElement('option');
                option.value = etapa;
                option.textContent = etapa;
                if (etapa === etapaAtual) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Substitui o badge pelo select
            badgeElement.replaceWith(select);
            select.focus(); // Foca no select para abrir o dropdown

            // Evento quando uma nova etapa é selecionada
            select.onchange = async () => {
                const novaEtapa = select.value;
                mostrarNotificacao(`🔄 Atualizando etapa para ${novaEtapa}...`, 'info');
                const sucesso = await atualizarEtapaBaserow(clienteId, novaEtapa);
                if (sucesso) {
                    const index = clientes.findIndex(c => c.id == clienteId);
                    if (index !== -1) {
                        clientes[index].etapa = novaEtapa;
                        clientes[index].dataAtualizacao = new Date().toISOString().split('T')[0];
                        
                        const todosCards = document.querySelectorAll(`.cliente-card[data-cliente-id="${clienteId}"]`);
                        todosCards.forEach(cardAntigo => {
                            const novoCard = criarCardCliente(clientes[index]);
                            if (cardAntigo.classList.contains('expandido')) {
                                novoCard.classList.add('expandido');
                            }
                            cardAntigo.parentNode.replaceChild(novoCard, cardAntigo);
                        });
                        mostrarNotificacao(`✅ Etapa atualizada para ${novaEtapa}!`, 'success');
                    }
                } else {
                    const badgeOriginal = criarBadgeEtapa(clienteId, etapaAtual);
                    select.replaceWith(badgeOriginal);
                    mostrarNotificacao('❌ Falha ao atualizar etapa.', 'error');
                }
            };

            select.onblur = () => {
                if (document.body.contains(select)) {
                     const badgeOriginal = criarBadgeEtapa(clienteId, etapaAtual);
                     select.replaceWith(badgeOriginal);
                }
            };
        }

        function criarBadgeEtapa(clienteId, etapa) {
            const badge = document.createElement('div');
            badge.className = 'etapa-badge';
            badge.textContent = etapa || 'N/D';
            badge.onclick = (event) => {
                event.stopPropagation();
                mostrarDropdownEtapa(badge, clienteId, etapa);
            };
            return badge;
        }

        async function atualizarEtapaBaserow(clienteId, novaEtapa) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return false; }
            try {
                const dadosBaserow = { "field_4477668": novaEtapa };
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, {
                    method: 'PATCH',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Atualizar Etapa):", response.status, errorBody);
                    throw new Error(`Erro ao atualizar etapa (${response.status}): ${errorBody || response.statusText}`);
                }
                return true; 
            } catch (error) {
                console.error("Falha ao atualizar etapa no Baserow:", error);
                return false; 
            }
        }
        
        async function toggleTarefaConcluida(clienteId) {
            const cliente = clientes.find(c => c.id == clienteId);
            if (!cliente) {
                mostrarNotificacao('Cliente não encontrado.', 'error');
                return;
            }
            const novoStatus = !cliente.tarefaConcluida;
            mostrarNotificacao(`🔄 Atualizando tarefa para ${novoStatus ? 'concluída' : 'pendente'}...`, 'info');

            const sucesso = await atualizarCampoBaserow(clienteId, {"Tarefa Concluida": novoStatus});

            if (sucesso) {
                cliente.tarefaConcluida = novoStatus;
                cliente.dataAtualizacao = new Date().toISOString().split('T')[0];
                
                const todosCards = document.querySelectorAll(`.cliente-card[data-cliente-id="${clienteId}"]`);
                todosCards.forEach(cardAntigo => {
                    const novoCard = criarCardCliente(cliente);
                    if (cardAntigo.classList.contains('expandido')) {
                        novoCard.classList.add('expandido');
                    }
                    cardAntigo.parentNode.replaceChild(novoCard, cardAntigo);
                });
                mostrarNotificacao(`✅ Tarefa marcada como ${novoStatus ? 'concluída' : 'pendente'}!`, 'success');
            } else {
                mostrarNotificacao('❌ Falha ao atualizar status da tarefa.', 'error');
            }
        }

        async function atualizarCampoBaserow(clienteId, camposParaAtualizar) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return false; }
            try {
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, {
                    method: 'PATCH',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(camposParaAtualizar)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Atualizar Campo):", response.status, errorBody);
                    throw new Error(`Erro ao atualizar campo (${response.status}): ${errorBody || response.statusText}`);
                }
                return true;
            } catch (error) {
                console.error("Falha ao atualizar campo no Baserow:", error);
                return false;
            }
        }

        function criarCardCliente(cliente) {
            const card = document.createElement('div');
            card.className = 'cliente-card';
            card.dataset.clienteId = cliente.id;
            card.onclick = () => expandirCard(card); 
            
            const etapa = cliente.etapa || 'N/D'; 
            
            card.innerHTML = `
                <div class="cliente-header">
                    <div class="cliente-info-principal">
                        <div class="cliente-name">${cliente.nome}</div>
                        <div class="etapa-badge-container"></div> 
                    </div>
                    <div class="cliente-email-tel-container">
                        <div class="cliente-email-tel">${cliente.email || 'N/D'} | ${cliente.telefone || 'N/D'}</div>
                        <div class="tarefa-status" onclick="event.stopPropagation(); toggleTarefaConcluida(${cliente.id})">
                            ${cliente.tarefaConcluida ? 
                              '<span style="color: #27ae60; font-weight: bold;">✓ Feito</span>' : 
                              '<span style="color: #e74c3c; font-weight: bold;">○ Pendente</span>'}
                        </div>
                    </div>
                </div>
                <div class="cliente-detalhes">
                    <div class="cliente-info">
                        <div class="info-row">
                            <span class="info-label">Tipo de Caso:</span>
                            <span class="info-value">${cliente.tipoCaso || 'N/D'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Advogado Responsável:</span>
                            <span class="info-value">${cliente.advogadoResponsavel || 'Não atribuído'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Acompanhamento:</span>
                            <span class="info-value">
                                ${cliente.acompanhamento || 'Não definido'}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Data de Expiração:</span>
                            <span class="info-value">${formatarDataHora(cliente.expira) || 'Não definida'}</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px; font-size: 0.9rem; color: #666;">
                        <strong>Observações:</strong><br>
                        ${cliente.observacoes || 'Nenhuma observação.'}
                    </div>
                    <div class="cliente-actions">
                        <button class="btn-small btn-edit" onclick="event.stopPropagation(); editarCliente(${cliente.id})">Editar</button>
                        <button class="btn-small btn-danger" onclick="event.stopPropagation(); confirmarExclusao(${cliente.id})">Excluir</button>
                    </div>
                </div>`;

            const etapaBadgeContainer = card.querySelector('.etapa-badge-container');
            const etapaBadge = criarBadgeEtapa(cliente.id, etapa);
            etapaBadgeContainer.appendChild(etapaBadge);

            return card;
        }

        function expandirCard(cardElement) {
            const clienteId = cardElement.dataset.clienteId;
            if (cardElement.classList.contains('expandido')) {
                const index = clientes.findIndex(c => c.id == clienteId);
                if (index !== -1) {
                    const novoCard = criarCardCliente(clientes[index]);
                    cardElement.parentNode.replaceChild(novoCard, cardElement);
                    return; 
                }
            }
            cardElement.classList.toggle('expandido');
        }

        function formatarData(dataISO) {
            if (!dataISO) return 'N/D';
            try {
                const data = new Date(dataISO);
                if (isNaN(data.getTime())) return dataISO; 
                const offset = data.getTimezoneOffset();
                const dataAjustada = new Date(data.getTime() + offset * 60 * 1000);
                return dataAjustada.toLocaleDateString('pt-BR');
            } catch (e) {
                console.warn("Erro ao formatar data:", dataISO, e);
                return dataISO; 
            }
        }
        
        function formatarDataHora(dataISO) {
            if (!dataISO) return 'N/D';
            try {
                const data = new Date(dataISO);
                if (isNaN(data.getTime())) return dataISO; 
                const dia = data.getDate().toString().padStart(2, '0');
                const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                const ano = data.getFullYear();
                const hora = data.getHours().toString().padStart(2, '0');
                const minuto = data.getMinutes().toString().padStart(2, '0');
                return `${dia}/${mes}/${ano} às ${hora}:${minuto}`;
            } catch (e) {
                console.warn("Erro ao formatar data e hora:", dataISO, e);
                return dataISO; 
            }
        }

        function atualizarEstatisticas() {
            document.getElementById('totalClientes').textContent = clientes.length;
            document.getElementById('clientesAtivos').textContent = clientes.filter(c => c.status === 'Ativo').length;
            document.getElementById('clientesPendentes').textContent = clientes.filter(c => c.status === 'Pendente').length;
            document.getElementById('clientesArquivados').textContent = clientes.filter(c => c.status === 'Arquivado').length;
        }

        function filtrarClientes(termoBusca) {
            termoBusca = termoBusca.toLowerCase();
            const tipoFiltro = document.getElementById('filtroTipo').value;
            const statusFiltro = document.getElementById('filtroStatus').value;

            document.querySelectorAll('.cliente-card').forEach(card => {
                const nome = card.querySelector('.cliente-name').textContent.toLowerCase();
                const email = card.querySelector('.cliente-email-tel').textContent.toLowerCase();
                const clienteId = card.dataset.clienteId;
                const cliente = clientes.find(c => c.id == clienteId);

                const correspondeBusca = nome.includes(termoBusca) || email.includes(termoBusca);
                const correspondeTipo = !tipoFiltro || (cliente && cliente.tipoCaso === tipoFiltro);
                const correspondeStatus = !statusFiltro || (cliente && cliente.status === statusFiltro);

                if (correspondeBusca && correspondeTipo && correspondeStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filtrarPorTipo(tipo) {
            filtrarClientes(document.querySelector('.search-box').value);
        }

        function filtrarPorStatus(status) {
            filtrarClientes(document.querySelector('.search-box').value);
        }

        function limparFiltros() {
            document.querySelector('.search-box').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            filtrarClientes('');
            mostrarNotificacao('Filtros limpos.', 'info');
        }

        function aplicarFiltros() {
            filtrarClientes(document.querySelector('.search-box').value);
        }

        const clienteModal = document.getElementById('clienteModal');
        const modalTitle = document.getElementById('modalTitle');
        const clienteForm = document.getElementById('clienteForm');
        const saveClientButton = document.getElementById('saveClientButton');

        function abrirModal(modo = 'adicionar', clienteId = null) {
            clienteForm.reset(); 
            clienteEmEdicaoId = null;
            if (modo === 'adicionar') {
                modalTitle.textContent = 'Novo Cliente';
                saveClientButton.onclick = salvarCliente; 
            } else if (modo === 'editar' && clienteId) {
                modalTitle.textContent = 'Editar Cliente';
                const cliente = clientes.find(c => c.id == clienteId);
                if (cliente) {
                    clienteEmEdicaoId = clienteId;
                    document.getElementById('nome').value = cliente.nome;
                    document.getElementById('email').value = cliente.email;
                    document.getElementById('telefone').value = cliente.telefone;
                    document.getElementById('tipoCaso').value = cliente.tipoCaso;
                    document.getElementById('advogadoResponsavel').value = cliente.advogadoResponsavel || '';
                    document.getElementById('status').value = cliente.status;
                    document.getElementById('observacoes').value = cliente.observacoes;
                    document.getElementById('acompanhamento').value = cliente.acompanhamento || '';
                    if (cliente.expira && cliente.expira.trim() !== '') {
                        try {
                            const dataExpira = new Date(cliente.expira);
                            if (!isNaN(dataExpira.getTime())) {
                                const ano = dataExpira.getFullYear();
                                const mes = (dataExpira.getMonth() + 1).toString().padStart(2, '0');
                                const dia = dataExpira.getDate().toString().padStart(2, '0');
                                const hora = dataExpira.getHours().toString().padStart(2, '0');
                                const minuto = dataExpira.getMinutes().toString().padStart(2, '0');
                                document.getElementById('expira').value = `${ano}-${mes}-${dia}T${hora}:${minuto}`;
                            } else {
                                document.getElementById('expira').value = '';
                            }
                        } catch (e) {
                            console.warn("Erro ao formatar data de expiração:", cliente.expira, e);
                            document.getElementById('expira').value = '';
                        }
                    } else {
                        document.getElementById('expira').value = '';
                    }
                    saveClientButton.onclick = salvarCliente; 
                } else {
                    mostrarNotificacao('Cliente não encontrado para edição.', 'error');
                    return; 
                }
            }
            clienteModal.style.display = 'flex';
        }

        function fecharModal() {
            clienteModal.style.display = 'none';
            clienteEmEdicaoId = null; 
        }

        function adicionarCliente() {
            abrirModal('adicionar');
        }

        function editarCliente(clienteId) {
            abrirModal('editar', clienteId);
        }

        async function salvarCliente() {
            const dadosForm = {
                nome: document.getElementById('nome').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                tipoCaso: document.getElementById('tipoCaso').value,
                advogadoResponsavel: document.getElementById('advogadoResponsavel').value.trim(),
                status: document.getElementById('status').value,
                observacoes: document.getElementById('observacoes').value.trim(),
                acompanhamento: document.getElementById('acompanhamento').value.trim(),
                expira: document.getElementById('expira').value,
                dataAtualizacao: new Date().toISOString().split('T')[0] 
            };

            if (!dadosForm.nome || !dadosForm.email || !dadosForm.telefone || !dadosForm.tipoCaso) {
                mostrarNotificacao('Preencha todos os campos obrigatórios.', 'error');
                return;
            }

            mostrarNotificacao('Salvando cliente...', 'info');
            let resultadoBaserow;

            if (clienteEmEdicaoId) {
                resultadoBaserow = await atualizarClienteBaserow(clienteEmEdicaoId, dadosForm);
                if (resultadoBaserow) {
                    const index = clientes.findIndex(c => c.id == clienteEmEdicaoId);
                    if (index !== -1) {
                        clientes[index] = { ...clientes[index], ...dadosForm, id: clienteEmEdicaoId }; 
                    }
                    mostrarNotificacao('Cliente atualizado com sucesso!');
                } else {
                    mostrarNotificacao('Falha ao atualizar cliente no Baserow.', 'error');
                }
            } else {
                resultadoBaserow = await salvarClienteBaserow(dadosForm);
                if (resultadoBaserow) {
                    const novoClienteLocal = { ...dadosForm, id: resultadoBaserow.id, etapa: resultadoBaserow.Etapa?.value || 'Análise Inicial' }; 
                    clientes.push(novoClienteLocal);
                    mostrarNotificacao('Cliente adicionado com sucesso!');
                } else {
                    mostrarNotificacao('Falha ao salvar cliente no Baserow.', 'error');
                }
            }
            if (resultadoBaserow) {
                carregarClientes(); 
                fecharModal();
            }
        }

        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');

        function confirmarExclusao(clienteId) {
            const cliente = clientes.find(c => c.id == clienteId);
            if (cliente) {
                clienteParaExcluirId = clienteId;
                confirmDeleteMessage.textContent = `Tem certeza que deseja excluir o cliente "${cliente.nome}"? Esta ação não pode ser desfeita.`;
                confirmDeleteModal.style.display = 'flex';
                confirmDeleteButton.onclick = async () => {
                    mostrarNotificacao('Excluindo cliente...', 'info');
                    const sucesso = await excluirClienteBaserow(clienteParaExcluirId);
                    if (sucesso) {
                        clientes = clientes.filter(c => c.id !== clienteParaExcluirId);
                        carregarClientes();
                        mostrarNotificacao('Cliente excluído com sucesso!');
                    } else {
                        mostrarNotificacao('Falha ao excluir cliente.', 'error');
                    }
                    fecharConfirmDeleteModal();
                };
            } else {
                mostrarNotificacao('Cliente não encontrado para exclusão.', 'error');
            }
        }

        function fecharConfirmDeleteModal() {
            confirmDeleteModal.style.display = 'none';
            clienteParaExcluirId = null;
        }

        const notificationElement = document.getElementById('notification');
        let notificationTimeout;

        function mostrarNotificacao(mensagem, tipo = 'success', duracao = 3000) {
            clearTimeout(notificationTimeout);
            notificationElement.textContent = mensagem;
            notificationElement.className = 'notification show'; 

            if (tipo === 'error') {
                notificationElement.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else if (tipo === 'info') {
                notificationElement.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            } else { 
                notificationElement.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
            }

            notificationTimeout = setTimeout(() => {
                notificationElement.classList.remove('show');
            }, duracao);
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkSession(); 
        });

    </script>
</body>
</html>

