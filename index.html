<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Jur√≠dico - Advocacia (com Login)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Estilos da tela de login */
        #loginScreen {
            display: flex; /* Alterado para flex no JS */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
        }
        #loginScreen > div {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            max-width: 400px;
            width: 90%;
        }
        #loginScreen h2 {
            color: #ecf0f1;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        #loginScreen p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }
        #baserowTokenInput {
            width: 100%;
            padding: 15px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            text-align: center;
        }
        #loginError {
            color: #e74c3c;
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        /* Estilos gerais do CRM (mantidos do original) */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .controls {
            display: flex;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            box-shadow: 0 4px 15px rgba(127, 140, 141, 0.3);
        }
        .search-box {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        .search-box:focus {
            border-color: #2c3e50;
            transform: scale(1.02);
        }
        .filter-select {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 180px;
        }
        .filter-select:focus,
        .filter-select:hover {
            border-color: #2c3e50;
            transform: scale(1.02);
        }
        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .status-groups-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .status-group {
            flex: 1;
            min-width: 300px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        .status-group::-webkit-scrollbar {
            width: 8px;
        }
        .status-group::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .status-group::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .status-group::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .status-group-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #ecf0f1;
            margin-bottom: 20px;
            padding-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .cliente-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .cliente-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }
        .cliente-header {
            display: flex;
            /* justify-content: space-between; /* Removido para alinhar info principal √† esquerda */
            flex-direction: column; /* Coloca email/tel abaixo */
            align-items: flex-start; /* Alinha itens √† esquerda */
            margin-bottom: 10px; /* Adiciona espa√ßo abaixo do header */
        }
        .cliente-info-principal {
            display: flex;
            align-items: center; /* Alinha nome e badge verticalmente */
            gap: 10px; /* Espa√ßo entre nome e badge */
            margin-bottom: 5px; /* Espa√ßo antes do email/tel */
        }
        .cliente-info-principal {
            display: flex;
            align-items: center; /* Alinha nome e badge verticalmente */
            gap: 10px; /* Espa√ßo entre nome e badge */
            margin-bottom: 5px; /* Espa√ßo antes do email/tel */
            width: 100%; /* Garante que ocupe toda a largura dispon√≠vel */
            justify-content: space-between; /* Empurra o badge para a direita */
        }
        .etapa-badge-container {
             /* O container agora s√≥ segura o badge/select */
             display: inline-block; /* Para que o container se ajuste ao conte√∫do */
             margin-left: auto; /* Empurra para a direita */
        }
        .cliente-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            /* margin-bottom: 4px; /* Removido, o gap cuida disso */
            flex: 1; /* Permite que o nome ocupe o espa√ßo dispon√≠vel */
        }
        .cliente-email-tel {
            color: #6b7280;
            font-size: 0.85rem;
            /* margin-top: 4px; /* Removido */
            width: 100%; /* Ocupa a largura para ficar abaixo */
        }
        .etapa-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            /* text-transform: uppercase; /* Removido para consist√™ncia com select */
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none; /* Garante que n√£o haja borda no badge */
            cursor: pointer; /* Indica que √© clic√°vel */
            display: inline-block; /* Para padding funcionar corretamente */
            transition: all 0.3s ease; /* Transi√ß√£o suave */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Sombra sutil para combinar com o select */
            min-width: 120px; /* Garante largura m√≠nima para conte√∫do */
            text-align: center; /* Centraliza o texto */
        }
        .etapa-badge:hover {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        /* Estilo para o select parecer com o badge */
        .etapa-badge-select {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none; /* Remove borda padr√£o do select */
            cursor: pointer;
            appearance: none; /* Remove apar√™ncia padr√£o do SO */
            -webkit-appearance: none;
            -moz-appearance: none;
            outline: none; /* Remove outline no foco */
            transition: all 0.2s ease; /* Adiciona transi√ß√£o suave */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Sombra sutil para efeito de eleva√ß√£o */
            min-width: 120px; /* Garante largura m√≠nima para conte√∫do */
            text-align: center; /* Centraliza o texto */
            /* Adiciona uma seta customizada sutil */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23ffffff%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%27%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            padding-right: 24px; /* Espa√ßo para a seta */
        }
        .etapa-badge-select:focus {
             box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5), 0 4px 8px rgba(0, 0, 0, 0.2); /* Brilho no foco + sombra */
             transform: translateY(-1px); /* Leve efeito de eleva√ß√£o ao focar */
             background: linear-gradient(135deg, #3498db, #2980b9); /* Mant√©m a mesma cor de fundo */
             color: white; /* Mant√©m a cor do texto */
        }
        .etapa-badge-select:hover {
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25); /* Sombra mais pronunciada no hover */
             transform: translateY(-1px); /* Leve efeito de eleva√ß√£o ao passar o mouse */
             background: linear-gradient(135deg, #3498db, #2980b9); /* Mant√©m a mesma cor de fundo */
        }
        /* Garante que as op√ß√µes do select tamb√©m tenham boa visibilidade */
        .etapa-badge-select option {
             background-color: #3498db; /* Cor de fundo similar ao gradiente */
             color: white; /* Texto branco para contraste */
             font-weight: 500; /* Peso da fonte para legibilidade */
        }
        .cliente-detalhes {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .cliente-card.expandido .cliente-detalhes {
            display: block;
        }
        .cliente-info {
            margin: 15px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .info-label {
            color: #6b7280;
            font-weight: 500;
        }
        .info-value {
            color: #1f2937;
            font-weight: 600;
        }
        .cliente-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .btn-edit {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .btn-edit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            max-width: 380px; /* Reduzido de 500px */
            width: 85%;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal h2 {
            margin-bottom: 15px; /* Reduzido de 20px */
            color: #1f2937;
            font-size: 1.4rem; /* Reduzido de 1.5rem */
        }
        .form-group {
            margin-bottom: 12px; /* Reduzido de 20px */
        }
        .form-group label {
            display: block;
            margin-bottom: 5px; /* Reduzido de 8px */
            color: #374151;
            font-weight: 600;
            font-size: 0.95rem; /* Ligeiramente menor */
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px; /* Reduzido de 12px 16px */
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Reduzido de 10px */
            font-size: 15px; /* Reduzido de 16px */
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
        }
        .form-group textarea {
            width: 100%;
            padding: 10px 14px; /* Reduzido de 12px 16px */
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Reduzido de 10px */
            font-size: 15px; /* Reduzido de 16px */
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            height: 80px; /* Altura reduzida para o textarea */
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #2c3e50;
            transform: scale(1.01); /* Reduzido de 1.02 */
        }
        .modal-actions {
            display: flex;
            gap: 12px; /* Reduzido de 15px */
            justify-content: flex-end;
            margin-top: 15px; /* Reduzido de 25px */
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stats-compact {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .stat-pill {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-number-compact {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ecf0f1;
        }
        .stat-label-compact {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-size: 0.9rem;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-icon:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.25);
        }
        .btn-icon-primary {
            background: rgba(52, 152, 219, 0.7);
        }
        .btn-icon-secondary {
            background: rgba(149, 165, 166, 0.7);
        }
        .search-container {
            flex: 1;
            min-width: 250px;
            display: flex;
            gap: 10px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(39, 174, 96, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }
        .notification.show {
            transform: translateX(0);
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            .clientes-grid {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="loginScreen">
        <div>
            <h2>Acesso ao CRM Jur√≠dico</h2>
            <p>Insira seu token da API Baserow para continuar.</p>
            <input type="password" id="baserowTokenInput" placeholder="Seu Token Baserow">
            <button onclick="handleLogin()" class="btn" style="width: 100%;">Entrar</button>
            <p id="loginError">Token inv√°lido. Tente novamente.</p>
        </div>
    </div>

    <!-- Conte√∫do Principal do CRM (inicialmente oculto) -->
    <div id="crmContent" style="display: none;">
        <div class="container">
            <div class="header-container">
                <div class="stats-compact">
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="totalClientes">0</div>
                        <div class="stat-label-compact">Total</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesAtivos">0</div>
                        <div class="stat-label-compact">Ativos</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesPendentes">0</div>
                        <div class="stat-label-compact">Pendentes</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-number-compact" id="clientesArquivados">0</div>
                        <div class="stat-label-compact">Arquivados</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-primary" title="Novo Cliente" onclick="adicionarCliente()">+</button>
                    <button class="btn-icon btn-icon-secondary" title="Sincronizar Baserow" onclick="sincronizarBaserow()">üîÑ</button>
                    <!-- O bot√£o Testar Conex√£o pode ser removido ou adaptado, pois o login j√° testa -->
                    <!-- <button class="btn-icon btn-icon-secondary" title="Testar Conex√£o" onclick="testarConexaoBaserow()">üîß</button> -->
                    <button class="btn-icon" title="Limpar Filtros" onclick="limparFiltros()">üóëÔ∏è</button>
                    <button class="btn-icon btn-danger" title="Logout" onclick="handleLogout()" style="background: rgba(231, 76, 60, 0.7);">üö™</button> <!-- Bot√£o Logout -->
                </div>
            </div>

            <div class="controls">
                <div class="search-container">
                    <select class="filter-select" id="filtroTipo" onchange="filtrarPorTipo(this.value)">
                        <option value="">Todos os Tipos</option>
                        <option value="Civil">Direito Civil</option>
                        <option value="Criminal">Direito Criminal</option>
                        <option value="Trabalhista">Direito Trabalhista</option>
                        <option value="Empresarial">Direito Empresarial</option>
                        <option value="Fam√≠lia">Direito de Fam√≠lia</option>
                        <option value="Tribut√°rio">Direito Tribut√°rio</option>
                    </select>
                    <select class="filter-select" id="filtroStatus" onchange="filtrarPorStatus(this.value)">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Arquivado">Arquivado</option>
                    </select>
                    <input type="text" class="search-box" placeholder="Buscar clientes..." onkeyup="filtrarClientes(this.value)">
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                    <button class="btn" onclick="mostrarCalendario()">Ver Calend√°rio de Tarefas</button>
                </div>
            </div>

            <!-- Calend√°rio de Tarefas (inicialmente oculto) -->
            <div id="calendarioContainer" style="display: none; margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 style="color: #ecf0f1; margin-bottom: 15px; text-align: center;">Calend√°rio de Tarefas</h2>
                    <div id="calendarioControles" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <button class="btn-small" onclick="mudarMes(-1)">‚óÄ M√™s Anterior</button>
                        <h3 id="mesAnoAtual" style="color: #ecf0f1; margin: 0; align-self: center;">Junho 2025</h3>
                        <button class="btn-small" onclick="mudarMes(1)">Pr√≥ximo M√™s ‚ñ∂</button>
                    </div>
                    <div id="calendario" style="background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 15px; color: #333;"></div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button class="btn-small btn-danger" onclick="fecharCalendario()">Fechar Calend√°rio</button>
                    </div>
                </div>
            </div>

            <div class="status-groups-container">
                <!-- Se√ß√£o de Clientes Ativos -->
                <div class="status-group">
                    <h2 class="status-group-title">Ativos</h2>
                    <div class="clientes-grid" id="gridAtivos">
                        <!-- Clientes ativos ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Se√ß√£o de Clientes Pendentes -->
                <div class="status-group">
                    <h2 class="status-group-title">Pendentes</h2>
                    <div class="clientes-grid" id="gridPendentes">
                        <!-- Clientes pendentes ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Se√ß√£o de Clientes Arquivados -->
                <div class="status-group">
                    <h2 class="status-group-title">Arquivados</h2>
                    <div class="clientes-grid" id="gridArquivados">
                        <!-- Clientes arquivados ser√£o carregados aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar/editar cliente -->
        <div class="modal" id="clienteModal">
            <div class="modal-content">
                <h2 id="modalTitle">Novo Cliente</h2>
                <form id="clienteForm">
                    <div class="form-group">
                        <label>Nome Completo:</label>
                        <input type="text" id="nome" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone:</label>
                        <input type="tel" id="telefone" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Caso:</label>
                        <select id="tipoCaso" required>
                            <option value="">Selecione...</option>
                            <option value="Civil">Direito Civil</option>
                            <option value="Criminal">Direito Criminal</option>
                            <option value="Trabalhista">Direito Trabalhista</option>
                            <option value="Empresarial">Direito Empresarial</option>
                            <option value="Fam√≠lia">Direito de Fam√≠lia</option>
                            <option value="Tribut√°rio">Direito Tribut√°rio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="status" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Arquivado">Arquivado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <textarea id="observacoes" rows="4" placeholder="Detalhes do caso, documentos necess√°rios, etc."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Pr√≥xima Etapa (Acompanhamento):</label>
                        <textarea id="acompanhamento" rows="2" placeholder="Descreva a pr√≥xima etapa ou tarefa a ser realizada"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Data de Expira√ß√£o:</label>
                        <input type="datetime-local" id="expira" placeholder="Data e hora limite">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-small btn-danger" onclick="fecharModal()">Cancelar</button>
                        <button type="button" id="saveClientButton" class="btn-small btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o de Exclus√£o -->
        <div class="modal" id="confirmDeleteModal">
            <div class="modal-content">
                <h2>Confirmar Exclus√£o</h2>
                <p id="confirmDeleteMessage" style="margin-bottom: 20px; color: #374151; line-height: 1.6;">Tem certeza que deseja excluir este cliente?</p>
                <div class="modal-actions">
                    <button type="button" class="btn-small btn-secondary" onclick="fecharConfirmDeleteModal()">Cancelar</button>
                    <button type="button" id="confirmDeleteButton" class="btn-small btn-danger">Confirmar Exclus√£o</button>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"></div>
    </div> <!-- Fim do crmContent -->

    <script>
        // Vari√°veis e fun√ß√µes para o calend√°rio
        let dataCalendarioAtual = new Date();
        let clientesComTarefas = [];
        
        function mostrarCalendario() {
            // Atualiza a lista de clientes com tarefas
            atualizarClientesComTarefas();
            
            // Atualiza o t√≠tulo do m√™s/ano
            atualizarTituloCalendario();
            
            // Renderiza o calend√°rio
            renderizarCalendario();
            
            // Exibe o container do calend√°rio
            document.getElementById('calendarioContainer').style.display = 'block';
        }
        
        function fecharCalendario() {
            document.getElementById('calendarioContainer').style.display = 'none';
        }
        
        function atualizarClientesComTarefas() {
            // Filtra apenas clientes que t√™m data de expira√ß√£o definida
            clientesComTarefas = clientes.filter(cliente => cliente.expira && cliente.expira.trim() !== '');
        }
        
        function atualizarTituloCalendario() {
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const mes = meses[dataCalendarioAtual.getMonth()];
            const ano = dataCalendarioAtual.getFullYear();
            document.getElementById('mesAnoAtual').textContent = `${mes} ${ano}`;
        }
        
        function mudarMes(delta) {
            dataCalendarioAtual.setMonth(dataCalendarioAtual.getMonth() + delta);
            atualizarTituloCalendario();
            renderizarCalendario();
        }
        
        function renderizarCalendario() {
            const calendario = document.getElementById('calendario');
            const ano = dataCalendarioAtual.getFullYear();
            const mes = dataCalendarioAtual.getMonth();
            
            // Determina o primeiro dia do m√™s e o √∫ltimo dia
            const primeiroDia = new Date(ano, mes, 1);
            const ultimoDia = new Date(ano, mes + 1, 0);
            
            // Determina o dia da semana do primeiro dia (0 = Domingo, 1 = Segunda, etc.)
            const primeiroDiaSemana = primeiroDia.getDay();
            
            // Cria a tabela do calend√°rio
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Dom</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Seg</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Ter</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Qua</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Qui</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Sex</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">S√°b</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Adiciona c√©lulas vazias para os dias antes do primeiro dia do m√™s
            let dia = 1;
            let htmlSemana = '<tr>';
            for (let i = 0; i < primeiroDiaSemana; i++) {
                htmlSemana += '<td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top;"></td>';
            }
            
            // Adiciona os dias do m√™s
            while (dia <= ultimoDia.getDate()) {
                // Se estamos no in√≠cio da semana, inicia uma nova linha
                if ((dia + primeiroDiaSemana - 1) % 7 === 0 && dia !== 1) {
                    htmlSemana += '</tr><tr>';
                }
                
                // Obt√©m as tarefas para este dia
                const tarefasDoDia = obterTarefasDoDia(ano, mes, dia);
                const hoje = new Date();
                const ehHoje = hoje.getDate() === dia && hoje.getMonth() === mes && hoje.getFullYear() === ano;
                
                // Estilo para destacar o dia atual
                const estiloDia = ehHoje ? 'background-color: rgba(52, 152, 219, 0.2);' : '';
                
                // Adiciona a c√©lula do dia com suas tarefas
                htmlSemana += `
                    <td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top; ${estiloDia}">
                        <div style="font-weight: bold; margin-bottom: 5px;">${dia}</div>
                        ${tarefasDoDia}
                    </td>
                `;
                
                dia++;
            }
            
            // Completa a √∫ltima semana com c√©lulas vazias se necess√°rio
            const ultimoDiaSemana = new Date(ano, mes, ultimoDia.getDate()).getDay();
            for (let i = ultimoDiaSemana + 1; i < 7; i++) {
                htmlSemana += '<td style="padding: 10px; border: 1px solid #ddd; height: 100px; vertical-align: top;"></td>';
            }
            
            htmlSemana += '</tr>';
            html += htmlSemana + '</tbody></table>';
            
            calendario.innerHTML = html;
        }
        
        function obterTarefasDoDia(ano, mes, dia) {
            let html = '';
            const dataAtual = new Date(ano, mes, dia);
            
            // Filtra tarefas para este dia
            const tarefasDoDia = clientesComTarefas.filter(cliente => {
                if (!cliente.expira) return false;
                
                const dataExpira = new Date(cliente.expira);
                return dataExpira.getDate() === dia && 
                       dataExpira.getMonth() === mes && 
                       dataExpira.getFullYear() === ano;
            });
            
            // Se h√° tarefas, adiciona-as √† c√©lula
            if (tarefasDoDia.length > 0) {
                tarefasDoDia.forEach(cliente => {
                    const dataExpira = new Date(cliente.expira);
                    const horaExpira = dataExpira.getHours().toString().padStart(2, '0');
                    const minutoExpira = dataExpira.getMinutes().toString().padStart(2, '0');
                    
                    // Determina a cor com base no status
                    let corStatus = '#3498db'; // Azul padr√£o
                    if (cliente.status === 'Ativo') corStatus = '#27ae60'; // Verde
                    else if (cliente.status === 'Pendente') corStatus = '#f39c12'; // Laranja
                    else if (cliente.status === 'Arquivado') corStatus = '#7f8c8d'; // Cinza
                    
                    // Verifica se a data j√° passou
                    const agora = new Date();
                    const expirado = dataExpira < agora;
                    const estiloExpirado = expirado ? 'text-decoration: line-through;' : '';
                    
                    html += `
                        <div style="margin-bottom: 5px; padding: 5px; border-radius: 4px; background-color: rgba(255,255,255,0.7); border-left: 3px solid ${corStatus}; font-size: 0.85rem; ${estiloExpirado}" 
                             onclick="event.stopPropagation(); editarCliente(${cliente.id})">
                            <div style="font-weight: bold;">${horaExpira}:${minutoExpira} - ${cliente.nome}</div>
                            <div style="font-size: 0.8rem; color: #555;">${cliente.acompanhamento || 'Sem descri√ß√£o'}</div>
                        </div>
                    `;
                });
            }
            
            return html;
        }
        
        // ========================================
        // L√ìGICA DE LOGIN E AUTENTICA√á√ÉO
        // ========================================
        let BASEROW_CONFIG = {
            baseUrl: 'https://api.baserow.io/api/database/rows/table/',
            tableId: '556046', // Seu Table ID original
            token: null, // Definido ap√≥s login
            headers: {
                'Authorization': '',
                'Content-Type': 'application/json'
            }
        };

        const loginScreen = document.getElementById('loginScreen');
        const crmContent = document.getElementById('crmContent');
        const tokenInput = document.getElementById('baserowTokenInput');
        const loginError = document.getElementById('loginError');

        async function testBaserowConnection(token) {
            try {
                const testHeaders = {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                };
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/?size=1`, {
                    method: 'GET',
                    headers: testHeaders
                });
                // Considera sucesso se n√£o for erro 401 (Unauthorized) ou 404 (Not Found - Tabela errada?)
                // Outros erros (5xx) podem indicar problemas no Baserow, mas a credencial pode estar ok.
                // Para simplificar, consideramos qualquer status < 400 como sucesso aqui.
                // Idealmente, verificar√≠amos o corpo da resposta para erros espec√≠ficos.
                return response.ok || (response.status >= 200 && response.status < 400);
            } catch (error) {
                console.error('Erro no teste de conex√£o:', error);
                return false;
            }
        }

        async function handleLogin() {
            const token = tokenInput.value.trim();
            loginError.style.display = 'none';

            if (!token) {
                loginError.textContent = 'Por favor, insira o token.';
                loginError.style.display = 'block';
                return;
            }

            mostrarNotificacao('üîë Verificando token...', 'info', 2000); // Feedback visual
            const isValidToken = await testBaserowConnection(token);

            if (isValidToken) {
                sessionStorage.setItem('baserowApiToken', token);
                BASEROW_CONFIG.token = token;
                BASEROW_CONFIG.headers['Authorization'] = `Token ${token}`;

                loginScreen.style.display = 'none';
                crmContent.style.display = 'block';

                mostrarNotificacao('‚úÖ Login bem-sucedido!', 'success');
                buscarClientesBaserow();
            } else {
                loginError.textContent = 'Token inv√°lido ou erro de conex√£o. Verifique o token e tente novamente.';
                loginError.style.display = 'block';
                mostrarNotificacao('‚ùå Falha no login.', 'error');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('baserowApiToken');
            BASEROW_CONFIG.token = null;
            BASEROW_CONFIG.headers['Authorization'] = '';
            crmContent.style.display = 'none';
            loginScreen.style.display = 'flex'; // Mostra a tela de login novamente
            tokenInput.value = ''; // Limpa o campo do token
            // Limpar os dados do CRM da tela (opcional, mas bom para seguran√ßa)
            document.getElementById('gridAtivos').innerHTML = '';
            document.getElementById('gridPendentes').innerHTML = '';
            document.getElementById('gridArquivados').innerHTML = '';
            document.getElementById('totalClientes').textContent = '0';
            document.getElementById('clientesAtivos').textContent = '0';
            document.getElementById('clientesPendentes').textContent = '0';
            document.getElementById('clientesArquivados').textContent = '0';
            mostrarNotificacao('üîí Logout realizado.', 'info');
        }

        async function checkSession() {
            const storedToken = sessionStorage.getItem('baserowApiToken');
            if (storedToken) {
                const isValid = await testBaserowConnection(storedToken);
                if (isValid) {
                    console.log('Token v√°lido encontrado na sess√£o. Autenticando automaticamente.');
                    BASEROW_CONFIG.token = storedToken;
                    BASEROW_CONFIG.headers['Authorization'] = `Token ${storedToken}`;
                    loginScreen.style.display = 'none';
                    crmContent.style.display = 'block';
                    buscarClientesBaserow();
                } else {
                    console.log('Token inv√°lido na sess√£o. Removendo.');
                    sessionStorage.removeItem('baserowApiToken');
                    loginScreen.style.display = 'flex';
                    crmContent.style.display = 'none';
                }
            } else {
                 loginScreen.style.display = 'flex';
                 crmContent.style.display = 'none';
            }
        }

        tokenInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleLogin();
            }
        });

        // ========================================
        // C√ìDIGO ORIGINAL DO CRM (ADAPTADO)
        // ========================================

        // Lista de op√ß√µes para o campo Etapa (fornecida pelo usu√°rio)
        const OPCOES_ETAPA = [
            "N√£o iniciada", "Lead Quente", "Lead Frio", "Aguardando Alvar√°",
            "Aguardando Audi√™ncia", "Aguardando Assinatura", "Aguardando Documenta√ß√£o",
            "Aguardando Senten√ßa", "Em Andamento", "Fase de 2¬∫ Grau",
            "Prazo para Manifesta√ß√£o", "Processo Distribuido", "Prazo de 7 dias Distribui√ß√£o",
            "Prazo Urgente para Peticionar", "Proposta Enviada", "Reuni√£o Marcada",
            "Conclu√≠do", "Perdido"
        ];

        // --- Fun√ß√µes para Edi√ß√£o Inline da Etapa ---

        // Fun√ß√£o para criar e mostrar o dropdown de etapas
        function mostrarDropdownEtapa(badgeElement, clienteId, etapaAtual) {
            // Cria o elemento select
            const select = document.createElement("select");
            select.className = "etapa-badge-select"; // Usa a classe CSS que definimos
            
            // Adiciona as op√ß√µes ao select
            OPCOES_ETAPA.forEach(opcao => {
                const option = document.createElement("option");
                option.value = opcao;
                option.textContent = opcao;
                if (opcao === etapaAtual) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Substitui o badge pelo select com anima√ß√£o suave
            badgeElement.style.opacity = "0";
            setTimeout(() => {
                badgeElement.replaceWith(select);
                // Efeito de fade-in para o select
                select.style.opacity = "0";
                setTimeout(() => {
                    select.style.opacity = "1";
                    select.focus(); // Foca no select para intera√ß√£o imediata
                }, 50);
            }, 150);

            // Evento quando uma nova etapa √© selecionada
            select.onchange = async () => {
                const novaEtapa = select.value;
                mostrarNotificacao(`üîÑ Atualizando etapa para ${novaEtapa}...`, 'info');
                const sucesso = await atualizarEtapaBaserow(clienteId, novaEtapa);
                if (sucesso) {
                    // Atualiza o array local
                    const index = clientes.findIndex(c => c.id == clienteId);
                    if (index !== -1) {
                        // Atualiza o objeto cliente no array
                        clientes[index].etapa = novaEtapa;
                        clientes[index].dataAtualizacao = new Date().toISOString().split('T')[0]; // Atualiza a data
                        
                        // Atualiza o badge visualmente sem recarregar a p√°gina
                        const novoBadge = criarBadgeEtapa(clienteId, novaEtapa);
                        select.replaceWith(novoBadge); // Substitui o select pelo novo badge
                        
                        // Re-renderiza completamente todos os cards do mesmo cliente
                        const todosCards = document.querySelectorAll(`.cliente-card[data-cliente-id="${clienteId}"]`);
                        todosCards.forEach(cardAntigo => {
                            // Cria um novo card com os dados atualizados
                            const novoCard = criarCardCliente(clientes[index]);
                            
                            // Preserva o estado expandido se necess√°rio
                            if (cardAntigo.classList.contains('expandido')) {
                                novoCard.classList.add('expandido');
                            }
                            
                            // Substitui o card antigo pelo novo
                            cardAntigo.parentNode.replaceChild(novoCard, cardAntigo);
                        });
                        
                        mostrarNotificacao(`‚úÖ Etapa atualizada para ${novaEtapa}!`, 'success');
                    }
                } else {
                    // Reverte para o badge original em caso de falha
                    const badgeOriginal = criarBadgeEtapa(clienteId, etapaAtual);
                    select.replaceWith(badgeOriginal);
                    mostrarNotificacao('‚ùå Falha ao atualizar etapa.', 'error');
                }
            };

            // Evento quando o select perde o foco (sem mudar valor)
            select.onblur = () => {
                // Verifica se o elemento ainda √© um select (pode j√° ter sido substitu√≠do no onchange)
                if (document.body.contains(select)) {
                     const badgeOriginal = criarBadgeEtapa(clienteId, etapaAtual);
                     select.replaceWith(badgeOriginal);
                }
            };
        }

        // Fun√ß√£o auxiliar para criar o elemento badge (para reutiliza√ß√£o)
        function criarBadgeEtapa(clienteId, etapa) {
            const badge = document.createElement('div');
            badge.className = 'etapa-badge';
            badge.textContent = etapa || 'N/D';
            badge.onclick = (event) => {
                event.stopPropagation();
                mostrarDropdownEtapa(badge, clienteId, etapa);
            };
            return badge;
        }

        // Fun√ß√£o para atualizar APENAS a etapa no Baserow
        async function atualizarEtapaBaserow(clienteId, novaEtapa) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return false; }
            try {
                const dadosBaserow = {
                    "field_4477668": novaEtapa // Atualiza apenas o campo da Etapa
                };

                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, {
                    method: 'PATCH',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Atualizar Etapa):", response.status, errorBody);
                    throw new Error(`Erro ao atualizar etapa (${response.status}): ${errorBody || response.statusText}`);
                }
                return true; // Sucesso
            } catch (error) {
                console.error("Falha ao atualizar etapa no Baserow:", error);
                return false; // Falha
            }
        }
        // --- Fim Fun√ß√µes Edi√ß√£o Inline ---

        // A constante BASEROW_CONFIG original foi REMOVIDA.
        // As fun√ß√µes abaixo agora usam a vari√°vel global BASEROW_CONFIG atualizada pelo login.

        // Fun√ß√£o para buscar clientes do Baserow (usa BASEROW_CONFIG global)
        async function buscarClientesBaserow() {
            if (!BASEROW_CONFIG.token) {
                mostrarNotificacao('Erro: Token n√£o encontrado. Fa√ßa login.', 'error');
                handleLogout(); // For√ßa logout se o token sumir
                return;
            }
            try {
                mostrarNotificacao('üîÑ Carregando dados do Baserow...');
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/`, { // Removido user_field_names=true
                    method: 'GET',
                    headers: BASEROW_CONFIG.headers
                });

                if (!response.ok) {
                     if (response.status === 401) {
                        mostrarNotificacao('Erro: Token inv√°lido ou expirado. Fa√ßa login novamente.', 'error');
                        handleLogout();
                        return;
                    }
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Dados recebidos do Baserow:', data);
                
                // Mapear usando os IDs dos campos (mais seguro)
                clientes = data.results.map(item => ({
                    id: item.id,
                    nome: item.field_4457729 || '', // Nome
                    email: item.field_4457730 || '', // Email
                    telefone: item.field_4457731 || '', // Telefone
                    tipoCaso: item.field_4457749 ? item.field_4457749.value : '', // Tipo de Caso (Select)
                    status: item.field_4457750 ? item.field_4457750.value : 'Pendente', // Status (Select)
                    etapa: item.field_4477668 ? item.field_4477668.value : 'An√°lise Inicial', // Etapa (Select)
                    observacoes: item.field_4457752 || '', // Observa√ß√µes
                    acompanhamento: item.field_4524618 || '', // Acompanhamento (pr√≥xima etapa)
                    expira: item.field_4524619 || '', // Data de expira√ß√£o
                    dataAtualizacao: item.field_4457753 || (item.updated_on ? item.updated_on.split('T')[0] : new Date().toISOString().split('T')[0]) // Data Atualiza√ß√£o ou updated_on
                }));

                carregarClientes();
                mostrarNotificacao(`‚úÖ ${clientes.length} clientes carregados do Baserow!`);
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados do Baserow:', error);
                mostrarNotificacao(`‚ùå Erro ao buscar dados: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o para salvar cliente no Baserow (usa BASEROW_CONFIG global)
        async function salvarClienteBaserow(cliente) {
             if (!BASEROW_CONFIG.token) { handleLogout(); return null; }
            try {
                // Usar os IDs dos campos para salvar (mais seguro)
                const dadosBaserow = {
                    "field_4457729": cliente.nome,           // Nome
                    "field_4457730": cliente.email,          // Email
                    "field_4457731": cliente.telefone,       // Telefone
                    "field_4457749": cliente.tipoCaso,       // Tipo de Caso (ID do valor do select)
                    "field_4457750": cliente.status,         // Status (ID do valor do select)
                    "field_4457752": cliente.observacoes,    // Observa√ß√µes
                    "field_4524618": cliente.acompanhamento, // Acompanhamento (pr√≥xima etapa)
                    "field_4524619": cliente.expira          // Data de expira√ß√£o
                    // "field_4477668": cliente.etapa // Se quiser salvar a etapa tamb√©m
                };

                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/`, { // Removido user_field_names=true
                    method: 'POST',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Salvar):", response.status, errorBody);
                    throw new Error(`Erro ao salvar (${response.status}): ${errorBody || response.statusText}`);
                }

                const novoCliente = await response.json();
                mostrarNotificacao("Cliente salvo no Baserow com sucesso!");
                return novoCliente; // Retorna o cliente criado com ID e outros campos
                
            } catch (error) {
                console.error("Falha ao salvar no Baserow:", error);
                mostrarNotificacao(`Erro ao salvar: ${error.message}`, "error");
                return null;
            }
        }

        // Fun√ß√£o para atualizar cliente no Baserow (usa BASEROW_CONFIG global)
        async function atualizarClienteBaserow(clienteId, dadosCliente) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return null; }
            try {
                 // Usar os IDs dos campos para atualizar (mais seguro)
                const dadosBaserow = {
                    "field_4457729": dadosCliente.nome,           // Nome
                    "field_4457730": dadosCliente.email,          // Email
                    "field_4457731": dadosCliente.telefone,       // Telefone
                    "field_4457749": dadosCliente.tipoCaso,       // Tipo de Caso
                    "field_4457750": dadosCliente.status,         // Status
                    "field_4457752": dadosCliente.observacoes,    // Observa√ß√µes
                    "field_4524618": dadosCliente.acompanhamento, // Acompanhamento (pr√≥xima etapa)
                    "field_4524619": dadosCliente.expira          // Data de expira√ß√£o
                    // "field_4477668": dadosCliente.etapa // Se quiser atualizar a etapa tamb√©m
                };

                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, { // Removido user_field_names=true
                    method: 'PATCH',
                    headers: BASEROW_CONFIG.headers,
                    body: JSON.stringify(dadosBaserow)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro Baserow (Atualizar):", response.status, errorBody);
                    throw new Error(`Erro ao atualizar (${response.status}): ${errorBody || response.statusText}`);
                }

                const clienteAtualizado = await response.json();
                mostrarNotificacao("Cliente atualizado no Baserow!");
                return clienteAtualizado;
                
            } catch (error) {
                console.error("Falha ao atualizar no Baserow:", error);
                mostrarNotificacao(`Erro ao atualizar: ${error.message}`, "error");
                return null;
            }
        }

        // Fun√ß√£o para excluir cliente no Baserow (usa BASEROW_CONFIG global)
        async function excluirClienteBaserow(clienteId) {
            if (!BASEROW_CONFIG.token) { handleLogout(); return false; }
            try {
                const response = await fetch(`${BASEROW_CONFIG.baseUrl}${BASEROW_CONFIG.tableId}/${clienteId}/`, {
                    method: 'DELETE',
                    headers: BASEROW_CONFIG.headers
                });

                // DELETE retorna 204 No Content em sucesso
                if (response.status !== 204) {
                     if (response.status === 401) {
                        mostrarNotificacao('Erro: Token inv√°lido ou expirado. Fa√ßa login novamente.', 'error');
                        handleLogout();
                        return false;
                    }
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                mostrarNotificacao('Cliente removido do Baserow!');
                return true;
                
            } catch (error) {
                console.error('Erro ao excluir do Baserow:', error);
                mostrarNotificacao(`Erro ao excluir do Baserow: ${error.message}`, 'error');
                return false;
            }
        }

        // Fun√ß√£o de sincroniza√ß√£o (apenas chama buscarClientesBaserow)
        function sincronizarBaserow() {
            buscarClientesBaserow();
        }

        // Fun√ß√£o testarConexaoBaserow (pode ser removida ou adaptada)
        // async function testarConexaoBaserow() {
        //     if (!BASEROW_CONFIG.token) {
        //         mostrarNotificacao('Fa√ßa login primeiro para testar a conex√£o.', 'info');
        //         return;
        //     }
        //     mostrarNotificacao('Testando conex√£o com Baserow...', 'info');
        //     const success = await testBaserowConnection(BASEROW_CONFIG.token);
        //     if (success) {
        //         mostrarNotificacao('‚úÖ Conex√£o com Baserow bem-sucedida!', 'success');
        //     } else {
        //         mostrarNotificacao('‚ùå Falha na conex√£o com Baserow. Verifique o token ou a rede.', 'error');
        //     }
        // }

        // ========================================
        // L√ìGICA DO CRM (FRONT-END)
        // ========================================
        let clientes = []; // Array para armazenar os clientes carregados
        let clienteParaExcluirId = null;
        let clienteEmEdicaoId = null; // Para saber se estamos editando ou adicionando

        function carregarClientes() {
            const gridAtivos = document.getElementById('gridAtivos');
            const gridPendentes = document.getElementById('gridPendentes');
            const gridArquivados = document.getElementById('gridArquivados');
            
            gridAtivos.innerHTML = '';
            gridPendentes.innerHTML = '';
            gridArquivados.innerHTML = '';

            clientes.forEach(cliente => {
                const card = criarCardCliente(cliente);
                if (cliente.status === 'Ativo') {
                    gridAtivos.appendChild(card);
                } else if (cliente.status === 'Pendente') {
                    gridPendentes.appendChild(card);
                } else if (cliente.status === 'Arquivado') {
                    gridArquivados.appendChild(card);
                }
            });

            atualizarEstatisticas();
            aplicarFiltros();
        }

        function criarCardCliente(cliente) {
            const card = document.createElement('div');
            card.className = 'cliente-card';
            card.dataset.clienteId = cliente.id;
            card.onclick = () => expandirCard(card); // Adiciona evento de clique para expandir
            
            const etapa = cliente.etapa || 'N/D'; // Usa 'N/D' se etapa n√£o definida
            
            card.innerHTML = `
                <div class="cliente-header">
                    <div class="cliente-info-principal">
                        <div class="cliente-name">${cliente.nome}</div>
                        <div class="etapa-badge-container"></div> <!-- Container para o badge/select -->
                    </div>
                    <div class="cliente-email-tel">${cliente.email || 'N/D'} | ${cliente.telefone || 'N/D'}</div>
                </div>
                <div class="cliente-detalhes">
                    <div class="cliente-info">
                        <div class="info-row">
                            <span class="info-label">Tipo de Caso:</span>
                            <span class="info-value">${cliente.tipoCaso || 'N/D'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value">${cliente.status || 'N/D'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">√öltima Atualiza√ß√£o:</span>
                            <span class="info-value">${formatarData(cliente.dataAtualizacao)}</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px; font-size: 0.9rem; color: #666;">
                        <strong>Observa√ß√µes:</strong><br>
                        ${cliente.observacoes || 'Nenhuma observa√ß√£o.'}
                    </div>
                    <div class="cliente-actions">
                        <button class="btn-small btn-edit" onclick="event.stopPropagation(); editarCliente(${cliente.id})">Editar</button>
                        <button class="btn-small btn-danger" onclick="event.stopPropagation(); confirmarExclusao(${cliente.id})">Excluir</button>
                    </div>
                </div>
            `;

            // Cria e adiciona o badge inicial ao container
            const etapaBadgeContainer = card.querySelector('.etapa-badge-container');
            const etapaBadge = criarBadgeEtapa(cliente.id, etapa);
            etapaBadgeContainer.appendChild(etapaBadge);

            return card;
        }

        function expandirCard(cardElement) {
            // Obt√©m o ID do cliente do card
            const clienteId = cardElement.dataset.clienteId;
            
            // Se estamos fechando um card expandido, vamos re-renderiz√°-lo completamente
            if (cardElement.classList.contains('expandido')) {
                // Encontra o cliente no array
                const index = clientes.findIndex(c => c.id == clienteId);
                if (index !== -1) {
                    // Cria um novo card com os dados atualizados
                    const novoCard = criarCardCliente(clientes[index]);
                    // Substitui o card antigo pelo novo (fechado)
                    cardElement.parentNode.replaceChild(novoCard, cardElement);
                    return; // Sai da fun√ß√£o, pois j√° substitu√≠mos o card
                }
            }
            
            // Se estamos expandindo ou n√£o encontramos o cliente, apenas alterna a classe
            cardElement.classList.toggle('expandido');
        }

        function formatarData(dataISO) {
            if (!dataISO) return 'N/D';
            try {
                const data = new Date(dataISO);
                // Adiciona verifica√ß√£o se a data √© v√°lida
                if (isNaN(data.getTime())) {
                    return dataISO; // Retorna a string original se n√£o for data v√°lida
                }
                // Ajuste para evitar problemas de fuso hor√°rio que mudam o dia
                const offset = data.getTimezoneOffset();
                const dataAjustada = new Date(data.getTime() + offset * 60 * 1000);
                return dataAjustada.toLocaleDateString('pt-BR');
            } catch (e) {
                console.warn("Erro ao formatar data:", dataISO, e);
                return dataISO; // Retorna original em caso de erro
            }
        }

        function atualizarEstatisticas() {
            document.getElementById('totalClientes').textContent = clientes.length;
            document.getElementById('clientesAtivos').textContent = clientes.filter(c => c.status === 'Ativo').length;
            document.getElementById('clientesPendentes').textContent = clientes.filter(c => c.status === 'Pendente').length;
            document.getElementById('clientesArquivados').textContent = clientes.filter(c => c.status === 'Arquivado').length;
        }

        function filtrarClientes(termoBusca) {
            termoBusca = termoBusca.toLowerCase();
            const tipoFiltro = document.getElementById('filtroTipo').value;
            const statusFiltro = document.getElementById('filtroStatus').value;

            document.querySelectorAll('.cliente-card').forEach(card => {
                const nome = card.querySelector('.cliente-name').textContent.toLowerCase();
                const email = card.querySelector('.cliente-email-tel').textContent.toLowerCase();
                const clienteId = card.dataset.clienteId;
                const cliente = clientes.find(c => c.id == clienteId);

                const correspondeBusca = nome.includes(termoBusca) || email.includes(termoBusca);
                const correspondeTipo = !tipoFiltro || (cliente && cliente.tipoCaso === tipoFiltro);
                const correspondeStatus = !statusFiltro || (cliente && cliente.status === statusFiltro);

                if (correspondeBusca && correspondeTipo && correspondeStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filtrarPorTipo(tipo) {
            filtrarClientes(document.querySelector('.search-box').value);
        }

        function filtrarPorStatus(status) {
            filtrarClientes(document.querySelector('.search-box').value);
        }

        function limparFiltros() {
            document.querySelector('.search-box').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            filtrarClientes('');
            mostrarNotificacao('Filtros limpos.', 'info');
        }

        function aplicarFiltros() {
            // Apenas chama a fun√ß√£o de filtrar com os valores atuais
            filtrarClientes(document.querySelector('.search-box').value);
        }

        // --- Fun√ß√µes do Modal --- 
        const clienteModal = document.getElementById('clienteModal');
        const modalTitle = document.getElementById('modalTitle');
        const clienteForm = document.getElementById('clienteForm');
        const saveClientButton = document.getElementById('saveClientButton');

        function abrirModal(modo = 'adicionar', clienteId = null) {
            clienteForm.reset(); // Limpa o formul√°rio
            clienteEmEdicaoId = null;
            if (modo === 'adicionar') {
                modalTitle.textContent = 'Novo Cliente';
                saveClientButton.onclick = salvarCliente; // Define a fun√ß√£o do bot√£o salvar
            } else if (modo === 'editar' && clienteId) {
                modalTitle.textContent = 'Editar Cliente';
                const cliente = clientes.find(c => c.id == clienteId);
                if (cliente) {
                    clienteEmEdicaoId = clienteId;
                    document.getElementById('nome').value = cliente.nome;
                    document.getElementById('email').value = cliente.email;
                    document.getElementById('telefone').value = cliente.telefone;
                    document.getElementById('tipoCaso').value = cliente.tipoCaso;
                    document.getElementById('status').value = cliente.status;
                    document.getElementById('observacoes').value = cliente.observacoes;
                    document.getElementById('acompanhamento').value = cliente.acompanhamento || '';
                    document.getElementById('expira').value = cliente.expira || '';
                    saveClientButton.onclick = salvarCliente; // Define a fun√ß√£o do bot√£o salvar
                } else {
                    mostrarNotificacao('Cliente n√£o encontrado para edi√ß√£o.', 'error');
                    return; // N√£o abre o modal se o cliente n√£o for encontrado
                }
            }
            clienteModal.style.display = 'flex';
        }

        function fecharModal() {
            clienteModal.style.display = 'none';
            clienteEmEdicaoId = null; // Limpa o ID em edi√ß√£o ao fechar
        }

        function adicionarCliente() {
            abrirModal('adicionar');
        }

        function editarCliente(clienteId) {
            abrirModal('editar', clienteId);
        }

        async function salvarCliente() {
            const dadosForm = {
                nome: document.getElementById('nome').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                tipoCaso: document.getElementById('tipoCaso').value,
                status: document.getElementById('status').value,
                observacoes: document.getElementById('observacoes').value.trim(),
                acompanhamento: document.getElementById('acompanhamento').value.trim(),
                expira: document.getElementById('expira').value,
                dataAtualizacao: new Date().toISOString().split('T')[0] // Atualiza data
            };

            // Valida√ß√£o simples
            if (!dadosForm.nome || !dadosForm.email || !dadosForm.telefone || !dadosForm.tipoCaso) {
                mostrarNotificacao('Preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }

            mostrarNotificacao('Salvando cliente...', 'info');
            let resultadoBaserow;

            if (clienteEmEdicaoId) {
                // Atualizar cliente existente
                resultadoBaserow = await atualizarClienteBaserow(clienteEmEdicaoId, dadosForm);
                if (resultadoBaserow) {
                    // Atualiza o cliente no array local
                    const index = clientes.findIndex(c => c.id == clienteEmEdicaoId);
                    if (index !== -1) {
                        // Mant√©m o ID original, atualiza o resto + data
                        clientes[index] = { ...clientes[index], ...dadosForm, id: clienteEmEdicaoId }; 
                    }
                    mostrarNotificacao('Cliente atualizado com sucesso!');
                } else {
                    mostrarNotificacao('Falha ao atualizar cliente no Baserow.', 'error');
                }
            } else {
                // Adicionar novo cliente
                resultadoBaserow = await salvarClienteBaserow(dadosForm);
                if (resultadoBaserow) {
                    // Adiciona o novo cliente (com ID retornado pelo Baserow) ao array local
                    const novoClienteLocal = { ...dadosForm, id: resultadoBaserow.id, etapa: resultadoBaserow.Etapa?.value || 'An√°lise Inicial' }; // Inclui ID e etapa
                    clientes.push(novoClienteLocal);
                    mostrarNotificacao('Cliente adicionado com sucesso!');
                } else {
                    mostrarNotificacao('Falha ao salvar cliente no Baserow.', 'error');
                }
            }

            if (resultadoBaserow) {
                carregarClientes(); // Recarrega a lista para refletir a mudan√ßa
                fecharModal();
            }
        }

        // --- Fun√ß√µes de Exclus√£o --- 
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');

        function confirmarExclusao(clienteId) {
            const cliente = clientes.find(c => c.id == clienteId);
            if (cliente) {
                clienteParaExcluirId = clienteId;
                confirmDeleteMessage.textContent = `Tem certeza que deseja excluir o cliente "${cliente.nome}"? Esta a√ß√£o n√£o pode ser desfeita.`;
                confirmDeleteModal.style.display = 'flex';
                // Define a a√ß√£o do bot√£o de confirma√ß√£o AQUI
                confirmDeleteButton.onclick = async () => {
                    mostrarNotificacao('Excluindo cliente...', 'info');
                    const sucesso = await excluirClienteBaserow(clienteParaExcluirId);
                    if (sucesso) {
                        clientes = clientes.filter(c => c.id !== clienteParaExcluirId);
                        carregarClientes();
                        mostrarNotificacao('Cliente exclu√≠do com sucesso!');
                    } else {
                        mostrarNotificacao('Falha ao excluir cliente.', 'error');
                    }
                    fecharConfirmDeleteModal();
                };
            } else {
                mostrarNotificacao('Cliente n√£o encontrado para exclus√£o.', 'error');
            }
        }

        function fecharConfirmDeleteModal() {
            confirmDeleteModal.style.display = 'none';
            clienteParaExcluirId = null;
        }

        // --- Notifica√ß√µes --- 
        const notificationElement = document.getElementById('notification');
        let notificationTimeout;

        function mostrarNotificacao(mensagem, tipo = 'success', duracao = 3000) {
            clearTimeout(notificationTimeout);
            notificationElement.textContent = mensagem;
            notificationElement.className = 'notification show'; // Remove tipos antigos

            if (tipo === 'error') {
                notificationElement.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else if (tipo === 'info') {
                notificationElement.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            } else { // success (default)
                notificationElement.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
            }

            notificationTimeout = setTimeout(() => {
                notificationElement.classList.remove('show');
            }, duracao);
        }

        // --- Inicializa√ß√£o --- 
        document.addEventListener('DOMContentLoaded', () => {
            checkSession(); // Verifica se h√° sess√£o ativa ao carregar
            // N√£o chama carregarClientes() aqui, pois checkSession ou handleLogin far√£o isso.
        });

    </script>
</body>
</html>